# 跨域

## 是什么

同源策略是一种约定，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，浏览器很容易受到 XSS、CSRF 等攻击。所谓同源是指"协议+域名+端口"三者相同，即便两个不同的域名指向同一个 ip 地址，也非同源。

- 同源策略限制内容有：
  - Cookie、LocalStorage、IndexedDB 等存储性内容
  - DOM 节点
  - AJAX 请求发送后，结果被浏览器拦截了
- 有三个标签允许跨域加载资源
  - <img>
  - <link>
  - <script>

跨域并不是请求发不出去，请求能发出去，服务端能收到请求并正常返回结果，只是结果被浏览器拦截了。

## 跨域解决策略

1. jsonp
   原理： 利用<script/> 能够支持跨域请求的特点，网页能够从来源动态加载 JSON 数据，需要对方的服务器做支持，且只支持 GET 命令
2. CORS
   需要浏览器和服务器同时支持，但是实际上，浏览器会自动进行 CORS 通信，关键在于后端的支持上
   服务器设置 Access-Control-Allow-Origin 即可开启 CORS，该属性下声明的域名，即表示域名可以访问资源
   在这种方式下，浏览器会发送请求时存在两种情况

- 简单请求
  - 条件一，使用 GET、HEAD、POST 三种方法之一
  - 条件二，Content-Type 取值，text/plain, multipart/form-data, application/x-www-form-urlencoded
- 复杂请求，暴怒是简单请求的请求。在正式通信前会进行一次 HTTP 查询请求，成为预检，方法为 option。
  3.postMessage
  postMessage 是 HTML5 XMLHttpRequest Level 2 中的 API，且是为数不多可以跨域操作的 window 属性之一，它可用于解决以下方面的问题：

- 页面和其打开的新窗口的数据传递
- 多窗口之间消息传递
- 页面与嵌套的 iframe 消息传递
- 上面三个场景的跨域数据传递
  postMessage()方法允许来自不同源的脚本采用异步方式进行有限的通信，可以实现跨文本档、多窗口、跨域消息传递。

4. webSocket
   Websocket 是 HTML5 的一个持久化的协议，它实现了浏览器与服务器的全双工通信，同时也是跨域的一种解决方案。WebSocket 和 HTTP 都是应用层协议，都基于 TCP 协议。但是 WebSocket 是一种双向通信协议，在建立连接之后，WebSocket 的 server 与 client 都能主动向对方发送或接收数据。同时，WebSocket 在建立连接时需要借助 HTTP 协议，连接建立好了之后 client 与 server 之间的双向通信就与 HTTP 无关了。

5. node 中间件代理
   同源策略是浏览器需要遵守的标准，服务器向服务器请求则不需要顾忌

6. nginx 代理
   实现原理类似于 Node 中间件代理，需要你搭建一个中转 nginx 服务器，用于转发请求。

使用 nginx 反向代理实现跨域，是最简单的跨域方式。只需要修改 nginx 的配置即可解决跨域问题，支持所有浏览器，支持 session，不需要修改任何代码，并且不会影响服务器性能。

实现思路：通过 nginx 配置一个代理服务器（域名与 domain1 相同，端口不同）做跳板机，反向代理访问 domain2 接口，并且可以顺便修改 cookie 中 domain 信息，方便当前域 cookie 写入，实现跨域登录。

剩下三种感觉不常用，具体可参考文档[](https://github.com/ljianshu/Blog/issues/~~55~~)
